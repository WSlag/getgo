rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: is the request from an authenticated user?
    function isAuth() {
      return request.auth != null;
    }

    // Helper: is the requesting user the document owner?
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Helper: is the requesting user an admin?
    function isAdmin() {
      return isAuth() && (
        request.auth.token.admin == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
      );
    }

    // Helper: block restricted marketplace actions for suspended users
    function isAccountActive() {
      return isAuth()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isActive', true) == true
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('accountStatus', 'active') != 'suspended';
    }

    // Helper: verify an order belongs to the caller
    function isOwnOrder(orderId) {
      return isAuth()
        && orderId is string
        && exists(/databases/$(database)/documents/orders/$(orderId))
        && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
    }

    // Helper: restrict screenshot URLs to trusted Firebase Storage payment paths
    function isTrustedPaymentScreenshotUrl(url, userId) {
      return url is string
        && (
          url.matches('^https://firebasestorage.googleapis.com/.*') ||
          url.matches('^https://storage.googleapis.com/.*')
        )
        && (
          url.matches('.*payments%2F' + userId + '%2F.*') ||
          url.matches('.*/payments/' + userId + '/.*')
        );
    }

    // Helper: is the requesting user part of a bid?
    function isBidParticipant(bidId) {
      return isAuth() && (
        get(/databases/$(database)/documents/bids/$(bidId)).data.bidderId == request.auth.uid ||
        get(/databases/$(database)/documents/bids/$(bidId)).data.listingOwnerId == request.auth.uid
      );
    }

    // Helper: identify which user will owe platform fee for a bid
    function feePayerIdForBid(bidData) {
      return bidData.cargoListingId != null ? bidData.bidderId : bidData.listingOwnerId;
    }

    // Helper: dynamic outstanding fee cap by trust level
    function outstandingCapForUser(userId) {
      let userData = get(/databases/$(database)/documents/users/$(userId)).data;
      let createdAt = userData.get('createdAt', request.time);
      let isNewAccount = request.time < createdAt + duration.value(30, 'd');
      let isVerified = userData.get('isVerified', false) == true;
      return !isVerified ? 2000 : (isNewAccount ? 3000 : 5000);
    }

    // Helper: enforce debt cap before allowing bid acceptance
    function canTakePlatformFeeDebt(bidData) {
      let payerId = feePayerIdForBid(bidData);
      let payerData = get(/databases/$(database)/documents/users/$(payerId)).data;
      let projectedOutstanding = payerData.get('outstandingPlatformFees', 0) + (bidData.price * 0.05);
      return payerData.get('isActive', true) == true
        && payerData.get('accountStatus', 'active') != 'suspended'
        && projectedOutstanding <= outstandingCapForUser(payerId);
    }

    function isBidAcceptanceTransition(oldData, newData) {
      return oldData.status != 'accepted' && newData.status == 'accepted';
    }

    // Users collection
    match /users/{uid} {
      // Only owners/admins can read full user documents (contains sensitive fields)
      allow read: if isOwner(uid) || isAdmin();

      // Users can create their own document but cannot set admin privileges
      allow create: if isOwner(uid)
        && request.resource.data.get('isAdmin', false) == false
        && request.resource.data.get('role', 'shipper') in ['shipper', 'trucker', 'broker']
        && request.resource.data.keys().hasOnly([
          'phone',
          'email',
          'name',
          'role',
          'profileImage',
          'facebookUrl',
          'isVerified',
          'isActive',
          'createdAt',
          'updatedAt'
        ]);

      // Prevent privilege/account state tampering from clients
      allow update: if isOwner(uid)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'name',
          'email',
          'profileImage',
          'facebookUrl',
          'updatedAt'
        ])
        && request.resource.data.isAdmin == resource.data.isAdmin
        && request.resource.data.role == resource.data.role;

      allow delete: if false;

      // Shipper Profile subcollection
      match /shipperProfile/{docId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if isOwner(uid);
      }

      // Trucker Profile subcollection
      match /truckerProfile/{docId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if isOwner(uid);
      }

      // Broker Profile subcollection (including nested referrals and commissions)
      match /brokerProfile/{docId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if false; // Server-authoritative only

        match /referrals/{refId} {
          allow read: if isOwner(uid) || isAdmin();
          allow write: if false;
        }

        match /commissions/{commId} {
          allow read: if isOwner(uid) || isAdmin();
          allow write: if false;
        }
      }

      // Wallet subcollection
      match /wallet/{docId} {
        allow read: if isOwner(uid) || isAdmin();
        // Only allow one-time wallet bootstrap with zero balance
        allow create: if isOwner(uid)
          && docId == 'main'
          && request.resource.data.balance == 0
          && request.resource.data.keys().hasOnly(['balance', 'createdAt', 'updatedAt']);
        allow update, delete: if false;
      }

      // Wallet Transactions subcollection
      match /walletTransactions/{txId} {
        allow read: if isOwner(uid) || isAdmin();
        allow create, update, delete: if false;
      }

      // Notifications subcollection
      match /notifications/{notifId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid);
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }

      // Broker Onboarding subcollection
      match /brokerOnboarding/{docId} {
        allow read: if isOwner(uid) || isAdmin();
        allow write: if isOwner(uid);
      }
    }

    // Vehicles
    match /vehicles/{vehicleId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Cargo Listings
    match /cargoListings/{listingId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Truck Listings
    match /truckListings/{listingId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Bids
    match /bids/{bidId} {
      allow read: if isAuth() && (
        resource.data.bidderId == request.auth.uid ||
        resource.data.listingOwnerId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAccountActive() && request.resource.data.bidderId == request.auth.uid;
      allow update: if isAuth() && (
        resource.data.bidderId == request.auth.uid ||
        (
          resource.data.listingOwnerId == request.auth.uid
          // Prevent tampering with core bid economics/participants during owner updates.
          && request.resource.data.bidderId == resource.data.bidderId
          && request.resource.data.listingOwnerId == resource.data.listingOwnerId
          && request.resource.data.price == resource.data.price
          && request.resource.data.cargoListingId == resource.data.cargoListingId
          && request.resource.data.truckListingId == resource.data.truckListingId
          // Before acceptance, ensure projected platform-fee debt is within cap.
          && (
            !isBidAcceptanceTransition(resource.data, request.resource.data) ||
            canTakePlatformFeeDebt(request.resource.data)
          )
        )
      );
      allow delete: if false;

      // Chat messages within a bid
      match /messages/{msgId} {
        allow read: if isBidParticipant(bidId) || isAdmin();
        allow create: if isBidParticipant(bidId) && request.resource.data.senderId == request.auth.uid;
        allow update: if (isBidParticipant(bidId) || isAdmin()) &&
          request.resource.data.senderId == resource.data.senderId &&
          request.resource.data.message == resource.data.message &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'read', 'updatedAt']);
        allow delete: if false;
      }
    }

    // Contracts
    match /contracts/{contractId} {
      allow read: if isAuth() && (
        request.auth.uid in resource.data.participantIds ||
        isAdmin()
      );
      // Client-side writes disabled: only trusted backend/Cloud Functions via Admin SDK
      allow create, update, delete: if false;
    }

    // Shipments
    match /shipments/{shipmentId} {
      allow read: if isAuth() && (
        request.auth.uid in resource.data.participantIds ||
        isAdmin()
      );
      // Client-side writes disabled: only trusted backend/Cloud Functions via Admin SDK
      allow create, update, delete: if false;
    }

    // Ratings
    match /ratings/{ratingId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.raterId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    // ============================================================
    // PAYMENT VERIFICATION SYSTEM
    // ============================================================

    // Payment Orders - Users can read their own orders
    // Only backend/Cloud Functions can create and update
    match /orders/{orderId} {
      allow read: if isAuth() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if false; // Only backend creates orders
      allow update: if false; // Only Cloud Functions update
      allow delete: if false;
    }

    // Payment Submissions - Users can read their own, create with restrictions
    // Only Cloud Functions can update after creation
    match /paymentSubmissions/{submissionId} {
      allow read: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuth()
        && request.resource.data.keys().hasOnly([
          'orderId',
          'bidId',
          'userId',
          'screenshotUrl',
          'status',
          'ocrStatus',
          'uploadedAt',
          'createdAt',
          'updatedAt'
        ])
        && request.resource.data.orderId is string
        && request.resource.data.screenshotUrl is string
        && request.resource.data.userId == request.auth.uid
        && isOwnOrder(request.resource.data.orderId)
        && get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.status in ['awaiting_upload', 'processing']
        && isTrustedPaymentScreenshotUrl(request.resource.data.screenshotUrl, request.auth.uid)
        && request.resource.data.status == 'pending'
        && request.resource.data.ocrStatus == 'pending';
      allow update: if false; // Only Cloud Functions can update
      allow delete: if false;
    }

    // Reference Numbers - No direct client access (Cloud Functions only)
    match /referenceNumbers/{refNumber} {
      allow read, write: if false;
    }

    // Image Hashes - No direct client access (Cloud Functions only)
    match /imageHashes/{hashId} {
      allow read, write: if false;
    }

    // Fraud Logs - Admin read only
    match /fraudLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions can write
    }

    // Platform Fees - Backend only (tracked via Admin SDK)
    match /platformFees/{feeId} {
      allow read: if isAuth() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only backend creates
    }

    // Broker public/private summaries managed by Cloud Functions
    match /brokers/{brokerId} {
      allow read: if isAuth() && (request.auth.uid == brokerId || isAdmin());
      allow write: if false;
    }

    // One referral attribution document per referred user (doc id = referred user id)
    match /brokerReferrals/{referredUserId} {
      allow read: if isAuth() && (
        request.auth.uid == referredUserId ||
        resource.data.brokerId == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }

    // Commission ledger (append-only server writes)
    match /brokerCommissions/{commissionId} {
      allow read: if isAuth() && (resource.data.brokerId == request.auth.uid || isAdmin());
      allow write: if false;
    }

    // Payout requests (server-managed workflow)
    match /brokerPayoutRequests/{requestId} {
      allow read: if isAuth() && (resource.data.brokerId == request.auth.uid || isAdmin());
      allow write: if false;
    }
  }
}
