rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: is the request from an authenticated user?
    function isAuth() {
      return request.auth != null;
    }

    // Helper: is the requesting user the document owner?
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{uid} {
      allow read: if isAuth();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      allow delete: if false;

      // Shipper Profile subcollection
      match /shipperProfile/{docId} {
        allow read: if isAuth();
        allow write: if isOwner(uid);
      }

      // Trucker Profile subcollection
      match /truckerProfile/{docId} {
        allow read: if isAuth();
        allow write: if isOwner(uid);
      }

      // Broker Profile subcollection (including nested referrals and commissions)
      match /brokerProfile/{docId} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);

        match /referrals/{refId} {
          allow read: if isOwner(uid);
          allow write: if isOwner(uid);
        }

        match /commissions/{commId} {
          allow read: if isOwner(uid);
          allow write: if isOwner(uid);
        }
      }

      // Wallet subcollection
      match /wallet/{docId} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
      }

      // Wallet Transactions subcollection
      match /walletTransactions/{txId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid);
        allow update: if false;
        allow delete: if false;
      }

      // Notifications subcollection
      match /notifications/{notifId} {
        allow read: if isOwner(uid);
        allow create: if isAuth();
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
    }

    // Vehicles
    match /vehicles/{vehicleId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Cargo Listings
    match /cargoListings/{listingId} {
      allow read: if true;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Truck Listings
    match /truckListings/{listingId} {
      allow read: if true;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Bids
    match /bids/{bidId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.bidderId == request.auth.uid;
      allow update: if isAuth() && (
        resource.data.bidderId == request.auth.uid ||
        resource.data.listingOwnerId == request.auth.uid
      );
      allow delete: if false;

      // Chat messages within a bid
      match /messages/{msgId} {
        allow read: if isAuth();
        allow create: if isAuth() && request.resource.data.senderId == request.auth.uid;
        allow update: if isAuth();
        allow delete: if false;
      }
    }

    // Contracts
    match /contracts/{contractId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow create: if isAuth() && request.auth.uid in request.resource.data.participantIds;
      allow update: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow delete: if false;
    }

    // Shipments
    match /shipments/{shipmentId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow create: if isAuth() && request.auth.uid in request.resource.data.participantIds;
      allow update: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow delete: if false;
    }

    // Ratings
    match /ratings/{ratingId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.raterId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
  }
}
